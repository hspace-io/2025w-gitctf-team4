<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Knights Frontier â€“ ë¯¸ì…˜ ëŒ€ì‹œë³´ë“œ</title>
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }

    body { 
      min-height: 100vh; 
      background: #040818; 
      color: #f5f5f5; 
      font-family: -apple-system, sans-serif; 
      display: flex; 
      justify-content: center; 
    }

    .page {
      width: 100%; 
      max-width: 1280px; 
      padding: 32px 24px 40px; 
    }

    header { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      margin-bottom: 32px; 
      position: relative; 
    }

    header img { 
      height: 110px; 
      object-fit: contain; 
    }

    .header-actions { 
      position: absolute; 
      right: 0; 
      top: 8px; 
      display: flex; 
      gap: 10px; 
    }

    .header-btn { 
      padding: 6px 14px; 
      border-radius: 999px; 
      font-size: 13px; 
      font-weight: 600; 
      border: 1px solid #8fa3ff; 
      background: transparent; 
      color: #e2e7ff; 
      cursor: pointer; 
      text-decoration: none; 
    }

    .header-btn.primary { 
      border-color: #27ae60; 
      color: #d8ffe7; 
    }

    .header-btn:hover { 
      background: rgba(143, 163, 255, 0.22); 
    }

    .mission-grid { 
      display: grid; 
      grid-template-columns: repeat(3, 1fr); 
      gap: 24px; 
    }

    .mission-card { 
      background: #dde5f5; 
      color: #1a2438; 
      border-radius: 18px; 
      overflow: hidden; 
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.45); 
      cursor: pointer; 
      transition: transform 0.2s; 
    }

    .mission-card:hover { 
      transform: translateY(-5px); 
    }

    /* ì¸ë„¤ì¼ + ìƒíƒœë°°ì§€ ì˜ì—­ */
    .card-img-wrapper {
      position: relative;
      width: 100%;
      height: 160px;
      overflow: hidden;
      background: #000;
    }

    .card-img-area { 
      width: 100%; 
      height: 160px; 
      object-fit: cover; 
      display: block;
    }

    .mission-status-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 8px;
      font-size: 11px;
      font-weight: 700;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.75);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.6);
      text-shadow: 0 1px 2px rgba(0,0,0,0.6);
    }

    .mission-status-badge.submitted {
      background: #27ae60;
      border-color: #a9dfbf;
    }

    .mission-status-badge.not-submitted {
      background: #7f8c8d;
      border-color: #bdc3c7;
    }

    .card-content { 
      padding: 20px; 
    }

    .mission-title { 
      font-size: 18px; 
      font-weight: 700;
      margin-bottom: 10px; 
    }

    .mission-desc { 
      font-size: 14px; 
      color: #555; 
      margin-bottom: 15px; 
      height: 40px; 
      overflow: hidden; 
    }

    .coin-badge { 
      display: inline-flex; 
      align-items: center; 
      font-weight: bold; 
      color: #8e6b02; 
      font-size: 13px; 
    }

    .coin-icon { 
      width: 20px; 
      height: 20px; 
      border-radius: 50%; 
      background: #f1c40f; 
      border: 2px solid #d4ac0d; 
      margin-right: 6px; 
      text-align: center; 
      line-height: 16px; 
    }

    .modal-overlay {
       display: none; 
       position: fixed; 
       top: 0; 
       left: 0; 
       width: 100%; 
       height: 100%; 
       background: rgba(0,0,0,0.7); 
       z-index: 1000; 
       justify-content: center; 
       align-items: center; 
    }

    .modal-content { 
      background: #f0f4ff; 
      color: #333; 
      padding: 30px; 
      border-radius: 16px; 
      width: 500px; 
      max-width: 90%; 
      position: relative; 
      max-height: 90vh; 
      overflow-y: auto; 
    }

    .close-btn { 
      position: absolute; 
      top: 15px; 
      right: 20px; 
      font-size: 24px; 
      cursor: pointer; 
    }

    input, textarea { 
      width: 100%; 
      padding: 10px; 
      margin: 8px 0; 
      border-radius: 8px; 
      border: 1px solid #ccc; 
    }

    textarea { 
      height: 80px; 
      resize: none; 
    }
    
    .btn-full { 
      width: 100%; 
      padding: 12px; 
      border: none; 
      border-radius: 8px; 
      font-weight: bold; 
      cursor: pointer; 
      margin-top: 10px; 
    }

    .btn-green { 
      background: #27ae60; 
      color: white; 
    }

    .btn-blue { 
      background: #3498db; 
      color: white; 
    }
    
    /* ê³¼ì œ ì œì¶œ ì˜ì—­ ìŠ¤íƒ€ì¼ */
    .submission-area { 
      background: #e8ecf7; 
      padding: 15px; 
      border-radius: 10px; 
      margin-top: 20px; 
      border: 1px solid #ccd4e8; 
    }

    .sub-label { 
      font-size: 13px; 
      font-weight: bold; 
      color: #555; 
      margin-bottom: 5px; 
      display: block; 
    }
    
    /* ì±„ì  ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    .judge-item { 
      background: #fff; 
      padding: 12px; 
      margin-bottom: 10px; 
      border-radius: 8px; 
      border: 1px solid #ddd; 
    }

    .judge-status { 
      font-weight: bold; 
      font-size: 12px; 
      padding: 2px 6px; 
      border-radius: 4px; 
    }

    .status-pending { 
      background: #f1c40f; 
      color: #fff; 
    }

    .status-success { 
      background: #27ae60; 
      color: #fff; 
    }

    .status-fail { 
      background: #e74c3c; 
      color: #fff; 
    }
    
    .hidden { 
      display: none !important; 
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 30px;
      gap: 15px;
    }

    .page-btn {
      padding: 8px 16px;
      background: #2c3e50;
      color: #ecf0f1;
      border: 1px solid #4a6bff;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }

    .page-btn:hover:not(:disabled) {
      background: #4a6bff;
      transform: translateY(-2px);
    }

    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      border-color: #555;
    }

    #pageIndicator {
      font-size: 16px;
      font-weight: bold;
      color: #8fa3ff;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="header-actions">
        <button id="addMissionBtn" class="header-btn primary hidden" onclick="openAddModal()">+ ë¯¸ì…˜ ì¶”ê°€</button>
        <a href="/store" class="header-btn">ìƒì </a>
        <a href="/mypage" class="header-btn">ë§ˆì´í˜ì´ì§€</a>
        <!-- knight ì „ìš© ê´€ë¦¬ì ë²„íŠ¼ -->
        <a id="adminBtn" href="/admin.html" class="header-btn hidden">ê´€ë¦¬í˜ì´ì§€</a>
      </div>
      <img src="logo_1.png" alt="Knights Frontier ë¡œê³ " />
    </header>

    <main>
      <div id="gridContainer" class="mission-grid"></div>

      <div class="pagination">
        <button id="prevBtn" class="page-btn" onclick="changePage(-1)">Prev</button>
        <span id="pageIndicator">1 í˜ì´ì§€</span>
        <button id="nextBtn" class="page-btn" onclick="changePage(1)">Next</button>
      </div>
    </main>
  </div>

  <!-- ë¯¸ì…˜ ì¶”ê°€ ëª¨ë‹¬ -->
  <div id="addModal" class="modal-overlay">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('addModal')">&times;</span>
      <h2>ìƒˆë¡œìš´ ë¯¸ì…˜ ìƒì„±</h2>
      <form id="addMissionForm">
        <input type="text" name="title" placeholder="ë¯¸ì…˜ ì œëª©" required>
        <input type="text" name="shortDesc" placeholder="ê°„ë‹¨ ì„¤ëª…" required>
        <textarea name="detailDesc" placeholder="ìƒì„¸ ì„¤ëª…"></textarea>
        <input type="number" name="coins" placeholder="ë³´ìƒ ì½”ì¸" required>
        <p class="sub-label">ëŒ€í‘œ ì´ë¯¸ì§€</p>
        <input type="file" name="missionImage" accept="image/*">
        <button type="submit" class="btn-full btn-green">ë¯¸ì…˜ ìƒì„±</button>
      </form>
    </div>
  </div>

  <!-- ë¯¸ì…˜ ìƒì„¸ / ì œì¶œ ëª¨ë‹¬ -->
  <div id="viewModal" class="modal-overlay">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('viewModal')">&times;</span>
      <h2 id="viewTitle"></h2>
      <img id="viewImg" src="" style="width:100%; border-radius:8px; display:none; margin:10px 0;">
      <p id="viewDesc" style="white-space: pre-wrap; color:#555; margin-bottom:10px;"></p>
      <div style="font-weight:bold; color:#d35400;">
        ë³´ìƒ: <span id="viewCoin">0</span> ì½”ì¸
      </div>

      <!-- ì¼ë°˜ ìœ ì € ì œì¶œ ì˜ì—­ -->
      <div id="userSubmitArea" class="submission-area hidden">
        <h3>ê³¼ì œ ì œì¶œ</h3>
        <form id="submitForm">
          <input type="hidden" id="submitMissionId">
          <input type="text" name="comment" placeholder="ë¸”ë¡œê·¸ ë§í¬ ë˜ëŠ” ì½”ë©˜íŠ¸" required>
          <p class="sub-label">íŒŒì¼ ì²¨ë¶€</p>
          <input type="file" name="file">
          <button type="submit" class="btn-full btn-green" id="submitButton">ì œì¶œí•˜ê¸°</button>
          <p id="submitStatusText" style="margin-top:8px; font-size:13px; color:#555; display:none;"></p>
        </form>
      </div>

      <!-- ê¸°ì‚¬(ê´€ë¦¬ì) ì˜ì—­ -->
      <div id="knightAdminArea" class="hidden" style="margin-top:20px;">
        <button class="btn-full btn-blue" onclick="openJudgeModal()">ì œì¶œëœ ê³¼ì œ í™•ì¸í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì±„ì  ëª¨ë‹¬ -->
  <div id="judgeModal" class="modal-overlay">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal('judgeModal')">&times;</span>
      <h2>ì œì¶œëœ ê³¼ì œ í˜„í™©</h2>
      <div id="submissionsList" style="margin-top:15px;"></div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let currentMissionId = null;
    let currentPage = 1;

    window.addEventListener('DOMContentLoaded', async () => {
      await loadUser();
      await loadMissions(currentPage);
    });

    // ìœ ì € ì •ë³´ ë¡œë“œ
    async function loadUser() {
      try {
        const res = await fetch('/api/users/me');
        if (res.ok) {
          currentUser = await res.json();
          if (currentUser.role === 'knight') {
            const addBtn = document.getElementById('addMissionBtn');
            const adminBtn = document.getElementById('adminBtn');
            if (addBtn) addBtn.classList.remove('hidden');
            if (adminBtn) adminBtn.classList.remove('hidden');
          }
        }
      } catch (e) {
        console.error(e);
      }
    }
    
    // ë¯¸ì…˜ ëª©ë¡ ë¡œë“œ
    async function loadMissions(page = 1) {
      try {
        const res = await fetch(`/api/missions?page=${page}`);
        const missions = await res.json();
        
        const container = document.getElementById('gridContainer');
        container.innerHTML = '';

        if (missions.length === 0 && page > 1) {
          alert('ë” ì´ìƒ ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.');
          changePage(-1);
          return;
        }

        missions.forEach(m => {
          const imgUrl = m.img_url || 'https://via.placeholder.com/300x160?text=No+Image';
          const card = document.createElement('div');
          card.className = 'mission-card';
          card.onclick = () => openViewModal(m.id);

          const statusText = m.hasSubmitted ? 'ì œì¶œë¨!' : 'ë¯¸ì œì¶œ';
          const statusClass = m.hasSubmitted ? 'submitted' : 'not-submitted';

          card.innerHTML = `
            <div class="card-img-wrapper">
              <img src="${imgUrl}" class="card-img-area">
              <div class="mission-status-badge ${statusClass}">
                ${statusText}
              </div>
            </div>
            <div class="card-content">
              <div class="mission-title">${m.title}</div>
              <div class="mission-desc">${m.short_desc || ''}</div>
              <div class="coin-badge">
                <div class="coin-icon">C</div> ${m.coins_reward}
              </div>
            </div>
          `;
          container.appendChild(card);
        });

        updatePaginationUI(missions.length);
      } catch (e) {
        console.error(e);
      }
    }

    function changePage(delta) {
      const newPage = currentPage + delta;
      if (newPage < 1) return;

      currentPage = newPage;
      loadMissions(currentPage);
    }

    function updatePaginationUI(itemCount) {
      document.getElementById('pageIndicator').innerText = `${currentPage} í˜ì´ì§€`;
      document.getElementById('prevBtn').disabled = (currentPage === 1);
      document.getElementById('nextBtn').disabled = itemCount < 9;
    }

    async function openViewModal(id) {
      try {
        currentMissionId = id;
        const res = await fetch(`/api/missions/${id}`);
        const m = await res.json();

        document.getElementById('viewTitle').innerText = m.title;
        document.getElementById('viewDesc').innerText = m.detail_desc || '';
        document.getElementById('viewCoin').innerText = m.coins_reward || 0;

        const img = document.getElementById('viewImg');
        img.src = m.img_url || '';
        img.style.display = m.img_url ? 'block' : 'none';

        const userSubmitArea = document.getElementById('userSubmitArea');
        const knightAdminArea = document.getElementById('knightAdminArea');
        const submitBtn = document.getElementById('submitButton');
        const statusText = document.getElementById('submitStatusText');

        if (currentUser && currentUser.role === 'knight') {
          userSubmitArea.classList.add('hidden');
          knightAdminArea.classList.remove('hidden');
          if (statusText) {
            statusText.textContent = '';
            statusText.style.display = 'none';
          }
        } else {
          userSubmitArea.classList.remove('hidden');
          knightAdminArea.classList.add('hidden');
          document.getElementById('submitMissionId').value = id;

          if (submitBtn && statusText) {
            if (m.hasSubmitted) {
              submitBtn.textContent = 'ì¬ì œì¶œí•˜ê¸°';

              let label = 'ì´ë¯¸ ì œì¶œí•œ ë¯¸ì…˜ì…ë‹ˆë‹¤. ì¬ì œì¶œ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
              if (m.lastStatus === 'pending') {
                label = 'ì´ë¯¸ ì œì¶œí•œ ë¯¸ì…˜ì…ë‹ˆë‹¤. (í˜„ì¬ ìƒíƒœ: ì‹¬ì‚¬ ëŒ€ê¸° ì¤‘) ì¬ì œì¶œ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
              } else if (m.lastStatus === 'success') {
                label = 'ìµœê·¼ ì œì¶œì´ ì„±ê³µ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. í•„ìš”í•œ ê²½ìš° ì¬ì œì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
              } else if (m.lastStatus === 'fail') {
                label = 'ìµœê·¼ ì œì¶œì´ ì‹¤íŒ¨ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ì¬ì œì¶œí•´ ì£¼ì„¸ìš”.';
              }

              statusText.textContent = label;
              statusText.style.display = 'block';
            } else {
              submitBtn.textContent = 'ì œì¶œí•˜ê¸°';
              statusText.textContent = '';
              statusText.style.display = 'none';
            }
          }
        }

        document.getElementById('viewModal').style.display = 'flex';
      } catch (e) {
        console.error(e);
        alert('ë¯¸ì…˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    document.getElementById('submitForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const mid = document.getElementById('submitMissionId').value;

      try {
        const res = await fetch(`/api/missions/${mid}/submit`, {
          method: 'POST',
          body: formData
        });
        const data = await res.json();

        if (res.ok) {
          alert(data.message || 'ì œì¶œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          closeModal('viewModal');
          loadMissions(currentPage);
        } else {
          alert(data.error || 'ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (e2) {
        console.error(e2);
        alert('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    async function openJudgeModal() {
      document.getElementById('submissionsList').innerHTML = 'ë¡œë”© ì¤‘...';
      document.getElementById('judgeModal').style.display = 'flex';

      try {
        const res = await fetch(`/api/missions/${currentMissionId}/submissions`);
        const list = await res.json();
        const container = document.getElementById('submissionsList');
        container.innerHTML = '';

        if (list.length === 0) {
          container.innerHTML = '<p>ì œì¶œëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        list.forEach(sub => {
          const div = document.createElement('div');
          div.className = 'judge-item';
          
          let fileHtml = sub.file_path 
            ? `<a href="${sub.file_path}" target="_blank" style="color:#3498db;">ğŸ“‚ ì²¨ë¶€íŒŒì¼ ë‹¤ìš´ë¡œë“œ</a>` 
            : '<span style="color:#999;">íŒŒì¼ ì—†ìŒ</span>';

          let actionHtml = '';
          if (sub.status === 'pending') {
            actionHtml = `
              <div style="margin-top:8px; display:flex; gap:5px;">
                <button onclick="judge(${sub.id}, 'success')" style="padding:5px 10px; background:#27ae60; color:white; border:none; border-radius:4px; cursor:pointer;">O ì„±ê³µ (ì½”ì¸ ì§€ê¸‰)</button>
                <button onclick="judge(${sub.id}, 'fail')" style="padding:5px 10px; background:#e74c3c; color:white; border:none; border-radius:4px; cursor:pointer;">X ì‹¤íŒ¨</button>
              </div>
            `;
          } else {
            actionHtml = `<div style="margin-top:5px; font-size:13px; color:#555;">íŒì • ì™„ë£Œ: <b>${sub.status}</b></div>`;
          }

          div.innerHTML = `
            <div><b>ë‹‰ë„¤ì„:</b> ${sub.nickname} (${sub.email})</div>
            <div><b>ë‚´ìš©:</b> ${sub.submit_comment}</div>
            <div style="margin:5px 0;">${fileHtml}</div>
            <span class="judge-status status-${sub.status}">${sub.status}</span>
            ${actionHtml}
          `;
          container.appendChild(div);
        });
      } catch (e) {
        console.error(e);
        alert('ì œì¶œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function judge(subId, result) {
      if (!confirm(result === 'success'
          ? 'ì„±ê³µ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì½”ì¸ì´ ì§€ê¸‰ë©ë‹ˆë‹¤.'
          : 'ì‹¤íŒ¨ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const res = await fetch('/api/missions/submissions/judge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ submissionId: subId, result, missionId: currentMissionId })
        });
        
        if (res.ok) {
          alert('ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
          openJudgeModal();
        } else {
          alert('ì˜¤ë¥˜ ë°œìƒ');
        }
      } catch (e) {
        console.error(e);
        alert('ì˜¤ë¥˜ ë°œìƒ');
      }
    }

    document.getElementById('addMissionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      try {
        const res = await fetch('/api/missions', { method: 'POST', body: formData });
        if (res.ok) {
          alert('ë¯¸ì…˜ ìƒì„± ì™„ë£Œ!');
          closeModal('addModal');
          loadMissions(currentPage);
        } else {
          const data = await res.json();
          alert(data.error || 'ë¯¸ì…˜ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (e2) {
        console.error(e2);
        alert('ë¯¸ì…˜ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    function openAddModal() {
      document.getElementById('addModal').style.display = 'flex';
    }
  </script>
</body>
</html>
