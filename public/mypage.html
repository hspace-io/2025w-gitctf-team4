<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Knights Frontier â€“ ë§ˆì´í˜ì´ì§€</title>
  <style>
    * { 
      box-sizing: border-box; 
      margin: 0; padding: 0; 
    }

    body { 
      min-height: 100vh; 
      background: #040818; 
      color: #f5f5f5; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; 
      display: flex; 
      justify-content: center; 
    }

    .page { 
      width: 100%; 
      max-width: 1280px; 
      padding: 32px 24px 40px; 
    }

    header { position: relative; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      margin-bottom: 32px; 
    }

    header img { 
      height: 110px; 
      object-fit: contain; 
    }

    .header-actions { 
      position: absolute; 
      right: 0; 
      top: 8px; 
      display: flex; 
      gap: 10px; 
    }

    .header-btn { 
      padding: 6px 14px; 
      border-radius: 999px; 
      font-size: 13px; 
      font-weight: 600; 
      border: 1px solid #8fa3ff; 
      background: transparent; 
      color: #e2e7ff; 
      cursor: pointer; 
      text-decoration: none; 
      transition: all 0.15s; 
    }

    .header-btn.primary { 
      border-color: #27ae60; 
      color: #d8ffe7; 
    }

    .header-btn:hover { 
      background: rgba(143, 163, 255, 0.22); 
    }

    .content { 
      display: flex; 
      gap: 32px; 
    }

    .card { 
      background: #dde5f5; 
      color: #1a2438; 
      border-radius: 18px; 
      padding: 24px 28px; 
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.45); 
    }

    .profile-card { 
      width: 360px; 
    }

    .profile-title { 
      font-size: 20px; 
      font-weight: 700; 
      margin-bottom: 16px; 
    }

    .profile-row { 
      display: flex; 
      align-items: center; 
      margin-bottom: 10px; 
      font-size: 15px; 
    }

    .profile-label { 
      width: 80px; 
      font-weight: 600; 
      color: #2c3e50; 
    }

    .profile-value { 
      flex: 1; 
    }

    .badge { 
      display: inline-block; 
      padding: 4px 10px; 
      border-radius: 999px; 
      background: #4a6bff; 
      color: #f5f7ff; 
      font-size: 12px; 
      font-weight: 600; 
      margin-top: 6px; 
    }

    .action-row { 
      margin-top: 18px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      gap: 10px; 
    }

    .edit-btn, .logout-btn { 
      padding: 8px 16px; 
      color: #ffffff; 
      border: none; 
      border-radius: 999px; 
      font-size: 13px; 
      font-weight: 600; 
      cursor: pointer; 
      text-decoration: none; 
    }

    .edit-btn { 
      background: #3498db; 
    } 
    
    .logout-btn { 
      background: #c0392b; 
    }

    .stats-card { 
      flex: 1; 
      display: flex; 
      flex-direction: column; 
      gap: 18px; 
    }

    .stats-section-title { 
      font-size: 18px; 
      font-weight: 700; 
      margin-bottom: 10px; 
    }

    .stat-row { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 8px; 
      font-size: 15px; 
    }

    .stat-label { 
      color: #2c3e50; 
    }

    .stat-value { 
      font-weight: 700;
    }

    .coin-icon { 
      width: 20px; 
      height: 20px; 
      border-radius: 50%; 
      background: radial-gradient(circle at 30% 30%, #fff9c4, #f1c40f); 
      border: 2px solid #d4ac0d; 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 11px; 
      font-weight: 700; 
      color: #8e6b02; 
      margin-right: 6px; 
    }

    .recent-list { 
      margin-top: 6px; 
      padding-left: 16px; 
      font-size: 14px; 
      color: #34495e; 
    }

    .recent-list li { 
      margin-bottom: 6px; 
    }
    
    /* ìƒíƒœë³„ ìƒ‰ìƒ */
    .status-success { 
      color: #27ae60; 
      font-weight: bold; 
    }

    .status-fail { 
      color: #c0392b; 
      font-weight: bold;
    }

    .status-pending { 
      color: #f39c12; 
      font-weight: bold; 
    }

    @media (max-width: 768px) { 
      .content { 
        flex-direction: column; 
      } 

      .profile-card { 
        width: 100%; 
        max-width: 360px; 
      } 

      header { 
        margin-bottom: 24px; 
      } 
      
      .header-actions { 
        position: static; 
        margin-left: auto; 
      } 
    }
  </style>
</head>
<script>
  async function loadUserInfo() {
    try {
      const response = await fetch('/api/users/me');
      
      if (!response.ok) {
        if (response.status === 401) {
          window.location.href = '/login';
          return;
        }
        throw new Error('ìœ ì € ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }

      const data = await response.json();
      
      // 1. í”„ë¡œí•„ ì •ë³´
      document.getElementById('user-nickname').textContent = data.nickname;
      document.getElementById('user-role').textContent = (data.role === 'knight') ? 'ğŸ›¡ï¸ ê¸°ì‚¬' : 'âš”ï¸ í‰ê¸°ì‚¬';
      document.getElementById('user-email').textContent = data.email;

      // 2. í†µê³„ ì •ë³´(ì½”ì¸, ì™„ë£Œ ë¯¸ì…˜, ì „ì²´ ë¯¸ì…˜)
      document.getElementById('user-coin').textContent = `${data.coin} ê°œ`;
      document.getElementById('stat-completed').textContent = `${data.stats.completed} ê°œ`;
      document.getElementById('stat-total').textContent = `${data.stats.total} ê°œ`;

      // 3. ìµœê·¼ í™œë™ ë‚´ì—­
      const listEl = document.getElementById('recent-activity-list');
      listEl.innerHTML = '';

      if (!data.recentActivities || data.recentActivities.length === 0) {
        listEl.innerHTML = '<li>ìµœê·¼ í™œë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
      } else {
        data.recentActivities.forEach(act => {
          // ë‚ ì§œ ë³€í™˜
          const date = new Date(act.created_at).toLocaleDateString();
          
          // ìƒíƒœ(pending, success, fail)ì— ë”°ë¼ ê¸€ìë‘ ìƒ‰ìƒ ì„ íƒ
          let statusText = '';
          let statusClass = '';
          if (act.status === 'success') { statusText = 'ì„±ê³µ'; statusClass = 'status-success'; }
          else if (act.status === 'fail') { statusText = 'ì‹¤íŒ¨'; statusClass = 'status-fail'; }
          else { statusText = 'ëŒ€ê¸°ì¤‘'; statusClass = 'status-pending'; }

          const li = document.createElement('li');
          li.innerHTML = `
            [${date}] <b>${act.title}</b> ì œì¶œ - <span class="${statusClass}">${statusText}</span>
          `;
          listEl.appendChild(li);
        });
      }
      
    } catch (error) {
      console.error('Error loading user info:', error);
    }
  }

  window.addEventListener('DOMContentLoaded', loadUserInfo);
</script>
<body>
  <div class="page">
    <header>
      <div class="header-actions">
        <a href="/main" class="header-btn">ëŒ€ì‹œë³´ë“œ</a>
        <a href="/store" class="header-btn">ìƒì </a>
        <a href="/mypage" class="header-btn primary">ë§ˆì´í˜ì´ì§€</a>
      </div>
      <img src="logo_1.png" alt="Knights Frontier ë¡œê³ " />
    </header>

    <main class="content">
      <section class="card profile-card">
        <div class="profile-title">ë‚´ ê¸°ì‚¬ í”„ë¡œí•„</div>

        <div class="profile-row">
          <div class="profile-label">ë‹‰ë„¤ì„</div>
          <div class="profile-value" id="user-nickname">-</div>
        </div>

        <div class="profile-row">
          <div class="profile-label">ë“±ê¸‰</div>
          <div class="profile-value" id="user-role">-</div>
        </div>

        <div class="profile-row">
          <div class="profile-label">ì´ë©”ì¼</div>
          <div class="profile-value" id="user-email">-</div>
        </div>

        <span class="badge">CTF ë¯¸ì…˜ ìˆ˜ë ¨ ì¤‘</span>

        <div class="action-row">
          <a href="/edit-profile" class="edit-btn">ì •ë³´ ìˆ˜ì •</a>
          <form id="logout-form" method="POST" action="/api/logout" style="margin: 0;">
            <button type="submit" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</button>
          </form>
        </div>
      </section>

      <section class="card stats-card">
        <div>
          <div class="stats-section-title">ë‚˜ì˜ ë³´ìƒ & ë¯¸ì…˜ í˜„í™©</div>

          <div class="stat-row">
            <span class="stat-label"><span class="coin-icon">C</span>ë³´ìœ  ì½”ì¸</span>
            <span class="stat-value" id="user-coin">0 ê°œ</span>
          </div>

          <div class="stat-row">
            <span class="stat-label">ì™„ë£Œí•œ ë¯¸ì…˜</span>
            <span class="stat-value" id="stat-completed">0 ê°œ</span>
          </div>

          <div class="stat-row">
            <span class="stat-label">ì§„í–‰ ì¤‘ì¸ ë¯¸ì…˜</span>
            <span class="stat-value" id="stat-total">0 ê°œ</span>
          </div>
        </div>

        <div>
          <div class="stats-section-title">ìµœê·¼ ë¯¸ì…˜ í™œë™</div>
          <ul class="recent-list" id="recent-activity-list">
          </ul>
        </div>
      </section>
    </main>
  </div>
</body>
</html>