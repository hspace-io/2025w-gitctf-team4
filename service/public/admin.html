<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Knights Frontier â€“ ê´€ë¦¬ì í˜ì´ì§€</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body { 
      min-height: 100vh; 
      background: #040818; 
      color: #f5f5f5; 
      font-family: -apple-system, sans-serif; 
      display: flex; 
      justify-content: center; 
    }

    .page { 
      width: 100%; 
      max-width: 1400px; 
      padding: 32px 24px 40px; 
    }

    header { 
      display: flex; 
      justify-content: space-between;
      align-items: center; 
      margin-bottom: 32px; 
    }

    .header-title {
      font-size: 28px;
      font-weight: 700;
      color: #8fa3ff;
    }

    .header-actions { 
      display: flex; 
      gap: 10px; 
    }

    .header-btn { 
      padding: 6px 14px; 
      border-radius: 999px; 
      font-size: 13px; 
      font-weight: 600; 
      border: 1px solid #8fa3ff; 
      background: transparent; 
      color: #e2e7ff; 
      cursor: pointer; 
      text-decoration: none; 
    }

    .header-btn:hover { 
      background: rgba(143, 163, 255, 0.22); 
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: #dde5f5;
      color: #1a2438;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }

    .stat-number {
      font-size: 32px;
      font-weight: 700;
      color: #4a6bff;
    }

    .stat-label {
      font-size: 14px;
      color: #555;
      margin-top: 8px;
    }

    .filters {
      background: #dde5f5;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #bcc7e3;
      background: #f5f7ff;
      color: #1a2438;
      font-size: 14px;
    }

    .submissions-table {
      background: #dde5f5;
      border-radius: 12px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #4a6bff;
      color: white;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #bcc7e3;
    }

    th {
      font-weight: 600;
      font-size: 14px;
    }

    td {
      color: #1a2438;
      font-size: 13px;
    }

    tbody tr:hover {
      background: rgba(74, 107, 255, 0.1);
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-pending { background: #f1c40f; color: #fff; }
    .status-success { background: #27ae60; color: #fff; }
    .status-fail { background: #e74c3c; color: #fff; }

    .action-btn {
      padding: 4px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      margin-right: 4px;
    }

    .btn-approve { background: #27ae60; color: white; }
    .btn-reject { background: #e74c3c; color: white; }
    .btn-view { background: #3498db; color: white; }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1 class="header-title">ğŸ›¡ï¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
      <div class="header-actions">
        <a href="/main" class="header-btn">ë¯¸ì…˜ ëŒ€ì‹œë³´ë“œ</a>
        <a href="/mypage" class="header-btn">ë§ˆì´í˜ì´ì§€</a>
        <button class="header-btn" style="border-color: #e74c3c; color: #ffb3b3;" onclick="deleteAllMissions()">
            ëª¨ë“  ë¯¸ì…˜ ì‚­ì œ
        </button>
      </div>
    </header>

    <!-- í†µê³„ ì¹´ë“œ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="stat-total">0</div>
        <div class="stat-label">ì´ ì œì¶œ ê±´ìˆ˜</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-pending">0</div>
        <div class="stat-label">ê²€í†  ëŒ€ê¸°</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-success">0</div>
        <div class="stat-label">ìŠ¹ì¸ë¨</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-fail">0</div>
        <div class="stat-label">ê±°ë¶€ë¨</div>
      </div>
    </div>

    <!-- í•„í„° -->
    <div class="filters">
      <select class="filter-select" id="filter-status">
        <option value="all">ì „ì²´ ìƒíƒœ</option>
        <option value="pending">ê²€í†  ëŒ€ê¸°</option>
        <option value="success">ìŠ¹ì¸ë¨</option>
        <option value="fail">ê±°ë¶€ë¨</option>
      </select>

      <select class="filter-select" id="filter-mission">
        <option value="all">ì „ì²´ ë¯¸ì…˜</option>
      </select>

      <input 
        type="text" 
        class="filter-select" 
        id="filter-user" 
        placeholder="ì‚¬ìš©ì ê²€ìƒ‰ (ì´ë©”ì¼ ë˜ëŠ” ë‹‰ë„¤ì„)"
      />
    </div>

    <!-- ì œì¶œ ë‚´ì—­ í…Œì´ë¸” -->
    <div class="submissions-table">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>ë¯¸ì…˜</th>
            <th>ì œì¶œì</th>
            <th>ì´ë©”ì¼</th>
            <th>ì œì¶œ ë‚´ìš©</th>
            <th>íŒŒì¼</th>
            <th>ìƒíƒœ</th>
            <th>ì œì¶œì¼</th>
            <th>ì‘ì—…</th>
          </tr>
        </thead>
        <tbody id="submissions-tbody">
          <tr>
            <td colspan="9" style="text-align: center; padding: 40px;">
              ë¡œë”© ì¤‘...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let allSubmissions = [];
    let missions = [];

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    window.addEventListener('DOMContentLoaded', async () => {
      await checkAdminAccess();
      await loadMissions();
      await loadAllSubmissions();
    });

    // ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
    async function checkAdminAccess() {
      try {
        const res = await fetch('/api/users/me');
        if (!res.ok) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = '/login';
          return;
        }
        
        const user = await res.json();
        if (user.role !== 'knight') {
          alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
          window.location.href = '/main';
        }
      } catch (err) {
        console.error(err);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        window.location.href = '/login';
      }
    }

    // ë¯¸ì…˜ ëª©ë¡ ë¡œë“œ
    async function loadMissions() {
      try {
        const res = await fetch('/api/missions?page=1&limit=1000');
        missions = await res.json();
        
        const select = document.getElementById('filter-mission');
        missions.forEach(m => {
          const option = document.createElement('option');
          option.value = m.id;
          option.textContent = m.title;
          select.appendChild(option);
        });
      } catch (err) {
        console.error(err);
      }
    }

    // ì „ì²´ ì œì¶œ ë‚´ì—­ ë¡œë“œ
    async function loadAllSubmissions() {
      try {
        const res = await fetch('/api/missions/submissions/all');
        if (!res.ok) throw new Error('ì œì¶œ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨');
        
        allSubmissions = await res.json();
        updateStats();
        renderSubmissions(allSubmissions);
      } catch (err) {
        console.error(err);
        document.getElementById('submissions-tbody').innerHTML = `
          <tr><td colspan="9" style="text-align: center; color: #e74c3c;">
            ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${err.message}
          </td></tr>
        `;
      }
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats() {
      document.getElementById('stat-total').textContent = allSubmissions.length;
      document.getElementById('stat-pending').textContent = 
        allSubmissions.filter(s => s.status === 'pending').length;
      document.getElementById('stat-success').textContent = 
        allSubmissions.filter(s => s.status === 'success').length;
      document.getElementById('stat-fail').textContent = 
        allSubmissions.filter(s => s.status === 'fail').length;
    }

    // ì œì¶œ ë‚´ì—­ ë Œë”ë§
    function renderSubmissions(submissions) {
      const tbody = document.getElementById('submissions-tbody');
      
      if (submissions.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="9" style="text-align: center; padding: 40px; color: #555;">
            ì œì¶œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
          </td></tr>
        `;
        return;
      }

      tbody.innerHTML = submissions.map(sub => {
        const mission = missions.find(m => m.id === sub.mission_id);
        const missionTitle = mission ? mission.title : `ë¯¸ì…˜ #${sub.mission_id}`;
        
        const fileHtml = sub.file_path 
          ? `<a href="${sub.file_path}" target="_blank" style="color:#3498db;">ë‹¤ìš´ë¡œë“œ</a>`
          : '<span style="color:#999;">ì—†ìŒ</span>';

        const actionHtml = sub.status === 'pending' 
          ? `
            <button class="action-btn btn-approve" onclick="judge(${sub.id}, 'success', ${sub.mission_id})">ìŠ¹ì¸</button>
            <button class="action-btn btn-reject" onclick="judge(${sub.id}, 'fail', ${sub.mission_id})">ê±°ë¶€</button>
          `
          : '<span style="color:#999;">ì²˜ë¦¬ì™„ë£Œ</span>';

        const date = new Date(sub.created_at).toLocaleString('ko-KR');

        return `
          <tr>
            <td>${sub.id}</td>
            <td>${missionTitle}</td>
            <td><b>${sub.nickname}</b></td>
            <td>${sub.email}</td>
            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
              ${sub.submit_comment || '-'}
            </td>
            <td>${fileHtml}</td>
            <td><span class="status-badge status-${sub.status}">${sub.status}</span></td>
            <td>${date}</td>
            <td>${actionHtml}</td>
          </tr>
        `;
      }).join('');
    }

    // ì±„ì  ì²˜ë¦¬
    async function judge(subId, result, missionId) {
      if (!confirm(result === 'success' ? 'ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?' : 'ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const res = await fetch('/api/missions/submissions/judge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ submissionId: subId, result, missionId })
        });

        if (res.ok) {
          alert('ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
          await loadAllSubmissions();
        } else {
          alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error(err);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // í•„í„° ì´ë²¤íŠ¸
    document.getElementById('filter-status').addEventListener('change', applyFilters);
    document.getElementById('filter-mission').addEventListener('change', applyFilters);
    document.getElementById('filter-user').addEventListener('input', applyFilters);

    function applyFilters() {
      const status = document.getElementById('filter-status').value;
      const mission = document.getElementById('filter-mission').value;
      const user = document.getElementById('filter-user').value.toLowerCase();

      let filtered = allSubmissions;

      if (status !== 'all') {
        filtered = filtered.filter(s => s.status === status);
      }

      if (mission !== 'all') {
        filtered = filtered.filter(s => s.mission_id === parseInt(mission));
      }

      if (user) {
        filtered = filtered.filter(s => 
          s.nickname.toLowerCase().includes(user) || 
          s.email.toLowerCase().includes(user)
        );
      }

      renderSubmissions(filtered);
    }

    async function deleteAllMissions() {
      if (!confirm('ì •ë§ë¡œ ëª¨ë“  ì œì¶œ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë¯¸ì…˜ ìì²´ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)')) {
        return;
      }

      try {
        const res = await fetch('/api/missions', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
      });

        const data = await res.json();

        if (res.ok) {
          alert(`ì œì¶œ ë‚´ì—­ ì „ì²´ ì‚­ì œ ì™„ë£Œ!\nì‚­ì œëœ ì œì¶œ ìˆ˜: ${data.deletedSubmissions ?? 0}ê°œ`);
          await loadMissions();
          await loadAllSubmissions();
        } else {
          alert('ì‚­ì œ ì‹¤íŒ¨: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
        }
      } catch (err) {
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
      }
    }
  </script>
</body>
</html>