<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Knights Frontier – 상점</title>
  <style>
    :root {
      --bg: #040818;
      --text: #f5f7ff;
      --muted: #b7c0ff;
      --brand: #8fa3ff;
      --brand-soft: #2b2f68;
      --brand-strong: #5e79ff;
      --card-bg: #0b1024;
      --surface: #151937;
      --border-subtle: #272c52;
      --radius-lg: 22px;
      --radius-md: 18px;
      --radius-pill: 999px;
      --shadow-strong: 0 18px 45px rgba(0,0,0,.55);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      background: #040818;
      color: #f5f5f5;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 1280px;
      padding: 32px 24px 40px;
    }

    header {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 32px;
      min-height: 170px;
    }

    header img {
      height: 110px;
      object-fit: contain;
    }

    .header-actions {
      position: absolute;
      right: 0;
      top: 8px;
      display: flex;
      gap: 10px;
    }

    .header-btn {
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      border: 1px solid #8fa3ff;
      background: transparent;
      color: #e2e7ff;
      cursor: pointer;
      text-decoration: none;
      transition: background 0.15s ease-out, color 0.15s ease-out,
        border-color 0.15s ease-out;
    }

    .header-btn.primary {
      border-color: #27ae60;
      color: #d8ffe7;
    }

    .header-btn:hover {
      background: rgba(143, 163, 255, 0.22);
    }

    .header-btn.primary:hover {
      background: rgba(39, 174, 96, 0.25);
    }

    @media (max-width: 768px) {
      header {
        margin-bottom: 24px;
      }

      .header-actions {
        position: static;
        margin-left: auto;
      }
    }

    main {
      max-width: 1120px;
      margin: 0 auto;
    }

    .shop-container {
      background: radial-gradient(1200px 600px at 0% 0%, #252c74 0%, #090b1f 50%, #050616 100%);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(74, 84, 143, 0.85);
      padding: 22px 24px 24px;
      box-shadow: var(--shadow-strong);
    }

    .shop-top-row {
      display: flex;
      align-items: center;
      gap: 18px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }

    .shop-tabs {
      display: inline-flex;
      padding: 4px;
      border-radius: var(--radius-pill);
      background: rgba(15, 18, 48, 0.9);
      border: 1px solid rgba(82, 98, 189, 0.85);
      gap: 6px;
    }

    .shop-tab {
      border: none;
      border-radius: var(--radius-pill);
      padding: 8px 18px;
      font-size: 13px;
      font-weight: 700;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      transition: background 0.16s ease, color 0.16s ease;
      white-space: nowrap;
    }

    .shop-tab.active {
      background: linear-gradient(135deg, #4853ff, #7a64ff);
      color: #f6f5ff;
      box-shadow: 0 0 0 1px rgba(185, 199, 255, 0.6);
    }

    .shop-search-wrapper {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      justify-content: flex-end;
    }

    .coin-balance {
      font-size: 13px;
      color: #f7e6a5;
      white-space: nowrap;
    }

    .search {
      background: radial-gradient(circle at 0 0, #242d6a 0%, #080b1c 60%);
      border-radius: var(--radius-pill);
      padding: 8px 14px;
      border: 1px solid rgba(85, 94, 166, 0.85);
      color: var(--text);
      font-size: 13px;
      min-width: 190px;
      max-width: 260px;
    }

    .search::placeholder {
      color: #6f78b7;
    }

    .search:focus-visible {
      outline: none;
      border-color: #99a7ff;
      box-shadow: 0 0 0 1px rgba(150,164,255,0.7);
    }

    .product-count {
      font-size: 13px;
      color: #a4aceb;
      white-space: nowrap;
    }

    @media (max-width: 768px) {
      .shop-top-row {
        align-items: flex-start;
      }
      .shop-search-wrapper {
        width: 100%;
        justify-content: space-between;
        flex-wrap: wrap;
        row-gap: 6px;
      }
      .search {
        flex: 1;
      }
    }

    .section-title {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 12px;
    }

    /* 상품 그리드 */
    .shop-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 16px;
    }

    @media (max-width: 1100px) {
      .shop-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (max-width: 880px) {
      .shop-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 600px) {
      .shop-grid {
        grid-template-columns: 1fr;
      }
    }

    /* 상품 카드 */
    .item-card {
      background: radial-gradient(circle at 0% 0%, #2b3365 0%, #141832 40%, #0a0d22 100%);
      border-radius: var(--radius-md);
      border: 1px solid rgba(77, 93, 163, 0.9);
      padding: 14px 14px 12px;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 190px;
    }

    .item-category-pill {
      position: absolute;
      top: 10px;
      left: 12px;
      font-size: 11px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: var(--radius-pill);
      background: linear-gradient(135deg, rgba(99, 115, 255, 0.32), rgba(88, 197, 255, 0.16));
      border: 1px solid rgba(158, 180, 255, 0.7);
      color: #dde4ff;
    }

    .item-name {
      font-size: 15px;
      font-weight: 800;
      margin-top: 32px;
      margin-bottom: 6px;
    }

    .item-desc {
      font-size: 12px;
      color: #c5cbff;
      line-height: 1.5;
      flex: 1;
      opacity: 0.95;
    }

    /* 하단: 가격 + 구매 버튼 */
    .item-bottom-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
      gap: 10px;
    }

    .item-price {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      font-weight: 700;
    }

    .coin-icon {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff9c4, #f1c40f);
      border: 2px solid #d4ac0d;
      display: grid;
      place-items: center;
      font-size: 11px;
      font-weight: 800;
      color: #7a5d02;
    }

    .item-price-amount {
      color: #f7e6a5;
    }

    .item-price-label {
      font-size: 12px;
      color: #c6c7ff;
      opacity: 0.9;
    }

    .buy-btn {
      border-radius: var(--radius-pill);
      border: none;
      padding: 7px 18px;
      font-size: 13px;
      font-weight: 800;
      cursor: pointer;
      background: linear-gradient(135deg, #6d7bff, #9574ff);
      color: #f5f4ff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap;
      transition: transform 0.08s ease, box-shadow 0.15s ease, opacity 0.15s ease, background 0.15s ease;
    }

    .buy-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(33, 44, 140, 0.65);
    }

    .buy-btn:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .buy-btn[disabled] {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .buy-btn.danger {
      background: linear-gradient(135deg, #c93f38, #ff7361);
    }

    /* ---------- 모달 ---------- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 5000;
    }

    .hidden {
      display: none;
    }

    .modal {
      width: 360px;
      max-width: calc(100% - 40px);
      background: #13162f;
      border-radius: 18px;
      padding: 20px 22px;
      border: 1px solid rgba(100,120,255,0.4);
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }

    .modal-title {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 16px;
      text-align: center;
    }

    .modal-info {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 18px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      padding: 6px 0;
      color: #d6dbff;
    }

    .info-row span:last-child {
      font-weight: 700;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .modal-btn {
      padding: 8px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      border: none;
      font-size: 14px;
    }

    .modal-btn.cancel {
      background: rgba(255,255,255,0.1);
      color: #c4c8e6;
    }

    .modal-btn.confirm {
      background: #6d7bff;
      color: #fff;
    }

    .modal-btn.confirm:hover {
      background: #8a97ff;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="header-actions">
        <a href="/main" class="header-btn">미션 대시보드</a>
        <a href="/mypage" class="header-btn primary">마이페이지</a>
      </div>
      <img src="logo_1.png" alt="Knights Frontier 로고" />
    </header>

    <main>
      <section class="shop-container" aria-label="코인샵">
        <div class="shop-top-row">
          <div class="shop-tabs" id="shop-tabs">
            <button class="shop-tab active" data-filter="all">전체 상품</button>
            <button class="shop-tab" data-filter="goods">HSPACE 굿즈</button>
            <button class="shop-tab" data-filter="digital">디지털 상품</button>
            <button class="shop-tab" data-filter="coupon">쿠폰</button>
          </div>

          <div class="shop-search-wrapper">
            <span class="coin-balance" id="coin-balance">보유 코인: -</span>
            <span class="product-count" id="product-count">총 0개 상품</span>
            <input
              type="search"
              class="search"
              placeholder="상품 이름 검색..."
              id="search-input"
            />
          </div>
        </div>

        <h2 class="section-title" id="section-title">전체 상품</h2>

        <div class="shop-grid" id="shop-grid">
          <!-- 상품 카드들은 JS에서 API로 받아와서 렌더링 -->
        </div>
      </section>
    </main>
  </div>

  <div id="modal-overlay" class="modal-overlay hidden">
    <div class="modal">
      <h3 class="modal-title">구매 확인</h3>

      <div class="modal-info">
        <div class="info-row">
          <span>현재 보유 코인</span>
          <span id="modal-current"></span>
        </div>
        <div class="info-row">
          <span>상품 가격</span>
          <span id="modal-price"></span>
        </div>
        <div class="info-row">
          <span>구매 후 잔여 코인</span>
          <span id="modal-result"></span>
        </div>
      </div>

      <div class="modal-actions">
        <button class="modal-btn cancel" id="modal-cancel">취소</button>
        <button class="modal-btn confirm" id="modal-confirm">구매하기</button>
      </div>
    </div>
  </div>

  <script>
    // --- 상태 변수 ---
    let userCoins = 0;
    let products = [];       // 서버에서 받는 전체 상품 목록
    let filteredProducts = []; // 필터(탭+검색) 후

    // --- DOM 참조 ---
    const shopGrid = document.getElementById("shop-grid");
    const tabs = document.querySelectorAll(".shop-tab");
    const searchInput = document.getElementById("search-input");
    const productCountEl = document.getElementById("product-count");
    const sectionTitleEl = document.getElementById("section-title");
    const coinBalanceEl = document.getElementById("coin-balance");

    const modalOverlay = document.getElementById("modal-overlay");
    const modalCurrent = document.getElementById("modal-current");
    const modalPrice = document.getElementById("modal-price");
    const modalResult = document.getElementById("modal-result");
    const modalCancel = document.getElementById("modal-cancel");
    const modalConfirm = document.getElementById("modal-confirm");

    let pendingProduct = null; // { id, name, price }

    const CATEGORY_LABELS = {
      all: "전체 상품",
      goods: "HSPACE 굿즈",
      digital: "디지털 상품",
      coupon: "쿠폰",
    };

    // --- API 호출 함수들 ---
    async function fetchStatus() {
      const res = await fetch("/api/shop/status");
      if (!res.ok) {
        if (res.status === 401) {
          alert("로그인이 필요합니다.");
          location.href = "/login";
          return;
        }
        throw new Error("status API 실패");
      }
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "status API error");
      userCoins = data.coin ?? 0;
      updateCoinUI();
    }

    async function fetchProducts(category = "all", search = "") {
      const params = new URLSearchParams();
      if (category && category !== "all") params.set("category", category);
      if (search) params.set("search", search);

      const res = await fetch("/api/shop/products?" + params.toString());
      if (!res.ok) throw new Error("products API 실패");
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "products API error");
      products = data.products || [];
      applyFilters(); // 탭/검색 필터 반영
    }

    async function purchaseProduct(productId) {
      const res = await fetch("/api/shop/purchase", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productId }),
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.ok) {
        const msg = data.error || "구매 중 오류가 발생했습니다.";
        alert(msg === "NOT_ENOUGH_COIN" ? "코인이 부족합니다." : msg);
        return null;
      }
      return data; // { ok, message, coin }
    }

    // --- 렌더링 로직 ---
    function renderProducts() {
      shopGrid.innerHTML = "";

      filteredProducts.forEach((p) => {
        const card = document.createElement("article");
        card.className = "item-card";
        card.dataset.category = p.category;
        card.dataset.price = p.price;
        card.dataset.id = p.id;

        const categoryPill = document.createElement("span");
        categoryPill.className = "item-category-pill";
        categoryPill.textContent = CATEGORY_LABELS[p.category] || "상품";

        const nameEl = document.createElement("h3");
        nameEl.className = "item-name";
        nameEl.textContent = p.name;

        const descEl = document.createElement("p");
        descEl.className = "item-desc";
        descEl.textContent = p.description || "";

        const bottomRow = document.createElement("div");
        bottomRow.className = "item-bottom-row";

        const priceBox = document.createElement("div");
        priceBox.className = "item-price";

        const coinIcon = document.createElement("span");
        coinIcon.className = "coin-icon";
        coinIcon.textContent = "C";

        const amountEl = document.createElement("span");
        amountEl.className = "item-price-amount";
        amountEl.textContent = p.price;

        const priceLabel = document.createElement("span");
        priceLabel.className = "item-price-label";
        priceLabel.textContent = "코인";

        priceBox.appendChild(coinIcon);
        priceBox.appendChild(amountEl);
        priceBox.appendChild(priceLabel);

        const buyBtn = document.createElement("button");
        buyBtn.className = "buy-btn";
        buyBtn.dataset.action = "buy";
        buyBtn.textContent = "구매";

        bottomRow.appendChild(priceBox);
        bottomRow.appendChild(buyBtn);

        card.appendChild(categoryPill);
        card.appendChild(nameEl);
        card.appendChild(descEl);
        card.appendChild(bottomRow);

        shopGrid.appendChild(card);
      });

      productCountEl.textContent = `총 ${filteredProducts.length}개 상품`;
    }

    function updateCoinUI() {
      coinBalanceEl.textContent = `보유 코인: ${userCoins}`;
    }

    function applyFilters() {
      const activeTab = document.querySelector(".shop-tab.active");
      const filter = activeTab ? activeTab.dataset.filter : "all";
      const keyword = (searchInput.value || "").toLowerCase();

      filteredProducts = products.filter((p) => {
        const matchCategory = filter === "all" || p.category === filter;
        const text = (p.name + " " + (p.description || "")).toLowerCase();
        const matchKeyword = !keyword || text.includes(keyword);
        return matchCategory && matchKeyword;
      });

      sectionTitleEl.textContent = CATEGORY_LABELS[filter] || "전체 상품";
      renderProducts();
    }

    // --- 이벤트 설정 ---
    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        tabs.forEach((t) => t.classList.remove("active"));
        tab.classList.add("active");
        applyFilters();
      });
    });

    searchInput.addEventListener("input", () => {
      applyFilters();
    });

    // 상품 그리드 내 구매 버튼 이벤트 (이벤트 위임)
    shopGrid.addEventListener("click", (e) => {
      const btn = e.target.closest(".buy-btn");
      if (!btn || btn.disabled) return;

      const card = btn.closest(".item-card");
      const price = Number(card.dataset.price);
      const id = Number(card.dataset.id);
      const name = card.querySelector(".item-name")?.textContent || "";

      pendingProduct = { id, name, price };

      modalCurrent.textContent = userCoins;
      modalPrice.textContent = price;
      const result = userCoins - price;
      modalResult.textContent = result >= 0 ? result : "코인 부족";

      modalOverlay.classList.remove("hidden");
    });

    modalCancel.addEventListener("click", () => {
      pendingProduct = null;
      modalOverlay.classList.add("hidden");
    });

    modalConfirm.addEventListener("click", async () => {
      if (!pendingProduct) return;

      const { id, price } = pendingProduct;

      if (userCoins < price) {
        alert("코인이 부족합니다!");
        modalOverlay.classList.add("hidden");
        pendingProduct = null;
        return;
      }

      const result = await purchaseProduct(id);
      if (!result) {
        // 실패 시
        modalOverlay.classList.add("hidden");
        pendingProduct = null;
        return;
      }

      alert(result.message || "구매 완료!");

      // 서버에서 내려준 최신 코인 값으로 갱신
      if (typeof result.coin === "number") {
        userCoins = result.coin;
      } else {
        userCoins -= price;
      }
      updateCoinUI();

      modalOverlay.classList.add("hidden");
      pendingProduct = null;

      // 필요하면 여기서 특정 상품 버튼을 비활성화하는 로직도 가능
      // (ex: 1회만 구매 가능한 상품)
    });

    // --- 초기 로딩 ---
    (async () => {
      try {
        await fetchStatus();
        await fetchProducts("all", "");
      } catch (err) {
        console.error(err);
        alert("상점 정보를 불러오는 중 오류가 발생했습니다.");
      }
    })();
  </script>
</body>
</html>
